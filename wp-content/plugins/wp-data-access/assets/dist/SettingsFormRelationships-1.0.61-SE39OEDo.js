const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CodeField-1.0.61-VcCGL0pj.js","./cm-1.0.61-D9ug3d5m.js","./redux-1.0.61-CrJ4jvTM.js","./vendor-1.0.61-CN03Eozo.js","./index-1.0.61-B7tjLD84.js","./Typography-1.0.61-Cg0Css-P.js","./lib-1.0.61-DoXQcMHD.js","./loglevel-1.0.61-BZ7XahX3.js","./lodash-1.0.61-C8OpKhUs.js","./moment-1.0.61-C5S46NFB.js","./ButtonBase-1.0.61-BqsrQx8o.js","./useEnhancedEffect-1.0.61-CX4-xj9Z.js","./ThemeProvider-1.0.61-4HOD8y6D.js","./Modal-1.0.61-DVFPMIPt.js","./notistack-1.0.61-0awN6uG4.js","./iconBase-1.0.61-C8saXaJ2.js","./cmJs-1.0.61-hWh8eEn6.js","./cmJson-1.0.61-BLURwXOE.js","./rehyperaw-1.0.61-AkovKNCK.js","./markdown-1.0.61-6nAzZWly.js","./cmHtml-1.0.61-ZqG0tpB4.js","./cmSql-1.0.61-CL9LoKgr.js","./Spinner-1.0.61-khi9zO7Q.js","./FormControlLabel-1.0.61-Bu2IQ4da.js","./Select-1.0.61-DmroHcG5.js","./Menu-1.0.61-D2OtRuzX.js","./createSvgIcon-1.0.61-DDgmYdEo.js","./Switch-1.0.61-CRYcdQMV.js","./SwitchBase-1.0.61-C2xa6JFZ.js","./DialogContent-1.0.61-Ws3r0VFj.js","./ConfirmDialog-1.0.61-BrxkBu_y.js","./cjs-1.0.61-D_0erLfe.js","./AdminTheme-1.0.61-D8bUxwpM.js"])))=>i.map(i=>d[i]);
import{j as e}from"./cm-1.0.61-D9ug3d5m.js";import{r as x}from"./redux-1.0.61-CrJ4jvTM.js";import{e as E,ae,p as ce,r as pe,q as te,M as de,y as ue,U as me,m as G}from"./index-1.0.61-B7tjLD84.js";import{C as he,a as Q,b as K}from"./ComponentColumn-1.0.61-CqYC2iYt.js";import{a as I,u as ne}from"./hooks-1.0.61-Bklk-gZu.js";import{u as xe}from"./useApp-1.0.61-C7D5dm7s.js";import{l as j,b5 as fe,S as je,bC as ie,w as ge,cn as be,co as Ce,x as N,bF as T,n as ye,a as R}from"./lib-1.0.61-DoXQcMHD.js";import{_ as Se}from"./cmJson-1.0.61-BLURwXOE.js";import{q as _e,r as Te}from"./index-1.0.61-Cpc7oUnN.js";import{u as J,S as Ae}from"./useFormUpdater-1.0.61-D3TDEm-F.js";import{D as we}from"./DefaultWhere-1.0.61-D25JpoiD.js";import{B as d}from"./Spinner-1.0.61-khi9zO7Q.js";import{F as M,I as X,b as F,T as ve}from"./TextField-1.0.61-DyvT2G_W.js";import{S as Z}from"./Select-1.0.61-DmroHcG5.js";import{M as $}from"./MenuItem-1.0.61-Bmr1xWyp.js";import{I as Y}from"./iconBase-1.0.61-C8saXaJ2.js";import{L as U}from"./Link-1.0.61-BHBICLVE.js";import{l as Re,m as Me,n as ze}from"./ActionsApp-1.0.61-CDhPoAR0.js";import{e as w}from"./notistack-1.0.61-0awN6uG4.js";import{T as Ne,a as B}from"./ToggleButtonGroup-1.0.61-31GAUuTm.js";import{S as Fe,a as Oe,b as ke}from"./Stepper-1.0.61-DGQ0aYov.js";import{B as z}from"./cjs-1.0.61-D_0erLfe.js";import{u as De}from"./useMetadata-1.0.61-CVl9oDgw.js";import{C as Ie}from"./ConfirmDialog-1.0.61-BrxkBu_y.js";import{u as We,C as qe}from"./useFormDetails-1.0.61-677sicqv.js";import{u as Be}from"./useRemoveAppFromStore-1.0.61-E72jey9_.js";import{P as Ee}from"./PremiumFeature-1.0.61-BxBWJ4MJ.js";import{T as Ye}from"./Typography-1.0.61-Cg0Css-P.js";import{H as Ue}from"./settings-1.0.61-BN5quc55.js";import{A as Je,a as Pe}from"./AccordionSummary-1.0.61-B21Kp3oq.js";import{A as Le}from"./AccordionDetails-1.0.61-CrQNuW_u.js";const se=r=>{const u=I();return x.useCallback((a,i)=>{Re({app_id:a.app.app[0].app_id,cnt_id:a.app.container[0].cnt_id},c=>{var g;const f=c==null?void 0:c.data;if(j.debug("response data",f),Array.isArray(f)){const _=((g=fe.getSelectors().selectFormState(je.getState().forms,r))==null?void 0:g.details)??[];j.debug(_);for(let C=0;C<f.length;C++){const n=ie(f[C]);if(n!==null&&n.cnt_id_master===a.app.container[0].cnt_id){const t=_.filter(b=>b.container.cnt_id===f[C].cnt_id);if(t.length===0){const b={appId:ge(),container:f[C]};u(be({appId:r,detail:b}))}else{const A={appId:t[0].appId,container:f[C]};u(Ce({appId:r,detail:A}))}}}}else console.error("error loading details",c),i!==void 0&&i()},c=>{console.error("error loading details",c),i!==void 0&&i()})},[r])},He=r=>{const u=ne(a=>{var i,c;return(c=(i=a.forms[r])==null?void 0:i.form)==null?void 0:c.detailDisplayType});return j.debug("detailDisplayType",u),u},Ve=x.lazy(()=>Se(()=>import("./CodeField-1.0.61-VcCGL0pj.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32]),import.meta.url)),ee=({appId:r,app:u,relationship:a,metaData:i,isRelationTable:c})=>{j.debug(r,u,a,i);const f=I(),g=J(r),[_,C]=x.useState(a.sql!==void 0&&a.sql!==""),[n,t]=x.useState(c?a.relationJoins.split(",").map(h=>{const p=h.split("=");return{masterColumn:p[0],detailColumn:p[1]??""}}):a.joins.split(",").map(h=>{const p=h.split("=");return{masterColumn:p[0],detailColumn:p[1]??""}}));j.debug("joins",n),x.useEffect(()=>{const h={...a};c?h.relationJoins=n.map(p=>p.masterColumn+"="+p.detailColumn).join(","):h.joins=n.map(p=>p.masterColumn+"="+p.detailColumn).join(","),f(N({property:"relationshipWizard",propertyValue:h})),g(!0)},[n]);const b=c?a.tbl:i.app.container[0].cnt_tbl,A=c?a.cls:i.app.container[0].cnt_cls===void 0||i.app.container[0].cnt_cls===null||i.app.container[0].cnt_cls===""?{}:JSON.parse(i.app.container[0].cnt_cls),O=c?u.appRelationTable:u.appTable,k=c?u.appRelationColumns:u.appColumns;return e.jsxs(d,{children:[...n.map((h,p)=>e.jsxs(d,{sx:{display:"grid",marginTop:"10px"},children:[e.jsxs(d,{sx:{display:"grid",gridTemplateColumns:"minmax(0, 1fr) 20px minmax(0, 1fr) auto",alignItems:"center"},children:[e.jsxs(M,{children:[e.jsx(X,{variant:"outlined",children:"master *"}),e.jsxs(Z,{MenuProps:{id:"pp-select-menu"},label:"master *",value:h.masterColumn,onChange:m=>{const S=[...n];S[p].masterColumn=m.target.value,t(S),g(!0)},children:[...A.map(m=>m.isSelected?e.jsxs($,{value:m.columnName,children:[b,".",m.columnName]}):null)]})]}),e.jsx(d,{sx:{textAlign:"center"},children:"="}),e.jsxs(M,{children:[e.jsx(X,{variant:"outlined",children:"detail *"}),e.jsxs(Z,{MenuProps:{id:"pp-select-menu"},label:"detail *",value:h.detailColumn,onChange:m=>{const S=[...n];S[p].detailColumn=m.target.value,t(S),g(!0)},children:[...k.map(m=>m.isSelected?e.jsxs($,{value:m.columnName,children:[O,".",m.columnName]}):null)]})]}),e.jsx(d,{children:p===0?e.jsx(E,{title:"Add condition",children:e.jsx(Y,{color:"primary",onClick:()=>{const m=[...n];m.push({masterColumn:"",detailColumn:""}),t(m),g(!0)},children:e.jsx(_e,{})})}):e.jsx(E,{title:"Delete condition",children:e.jsx(Y,{color:"primary",onClick:()=>{const m=[...n];m.splice(p,1),t(m),g(!0)},children:e.jsx(Te,{})})})})]}),e.jsx(d,{children:e.jsx(M,{children:e.jsx(F,{children:"Updating requires a table reload."})})})]})),e.jsx(d,{sx:{marginTop:"20px"},children:_?e.jsxs(M,{fullWidth:!0,children:[e.jsx(x.Suspense,{children:e.jsx(Ve,{code:c?a.relationSql:a.sql,setCode:h=>{const p={...a};c?p.relationSql=h:p.sql=h,f(N({property:"relationshipWizard",propertyValue:p})),g(!0)},dialogTitle:"Optional conditions",extension:"sql"})}),e.jsx(we,{})]}):e.jsxs(U,{onClick:()=>C(!0),sx:{textDecoration:"none",cursor:"pointer",display:"flex",alignItems:"center",gap:"5px"},children:[e.jsx(ae,{}),e.jsx("span",{children:"Add SQL conditions"})]})}),a.cardinality===T.ONE_TO_ONE&&e.jsx(d,{sx:{marginTop:"20px"},children:e.jsx(M,{fullWidth:!0,children:e.jsx(F,{children:"A join for a 1:1 relationship must return exactly one record. An error is shown when a detail query returns more than 1 record."})})})]})},Ge=()=>{const r=ne(u=>u.apps.relationshipWizard);return j.debug("relationship",r),r},Qe=({appId:r,metaData:u,isUpdating:a,initialRelationships:i,initialTitle:c,embedded:f,enableWizard:g})=>{const _=I(),C=se(r),n=xe(),t=Ge(),b=J(r),[A,O]=x.useState(f);j.debug("typeSelected",A),x.useEffect(()=>{const s={...t};s.title=n.appTitle??"",s.dbs=n.appDatabase??"",s.tbl=n.appTable??"",s.cls=n.appColumns,s.relationTbl=n.appRelationTable??"",s.relationCls=n.appRelationColumns,_(N({property:"relationshipWizard",propertyValue:s}))},[n.appDatabase,n.appTable,n.appRelationTable,n.appColumns,n.appRelationColumns,n.appTitle]);const[k,h]=x.useState(""),p=x.useMemo(()=>t.cardinality===T.MANY_TO_MANY?["Relationship title","Select join table","Define join table join condition","Select relation table","Define relation table join condition"]:["Relationship title","Select data source","Define join condition"],[t.cardinality]),[m,S]=x.useState(0),W=s=>{switch(j.debug(s),s){case 0:if(n.appTitle===""||n.appTitle===null||c!==n.appTitle&&i.filter(l=>l.title===n.appTitle).length>0)return h("title"),!1;h("");break;case 1:if(n.appDatabase===""||n.appDatabase===null||n.appTable===""||n.appTable===null||n.appColumns.filter(l=>l.isSelected===!0).length===0)return!1;h("");break;case 2:if(t.joins==="=")return!1;h("");break;case 3:if(n.appRelationColumns.filter(l=>l.isSelected===!0).length===0)return!1;h("");break;case 4:if(t.relationJoins==="=")return!1;h("");break}return!0},v=s=>(j.debug(s),e.jsxs(d,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",justifyContent:"space-between",alignItems:"center",gap:"5px"},children:[s===0?e.jsx(d,{}):e.jsx(z,{variant:"contained",startIcon:e.jsx(ce,{}),onClick:()=>{S(s-1)},children:"Previous"}),s===2&&t.cardinality!==T.MANY_TO_MANY||s===4&&t.cardinality===T.MANY_TO_MANY?e.jsx(z,{variant:"contained",startIcon:e.jsx(pe,{}),onClick:()=>{W(s)&&S(s+1)},children:"Finish"}):e.jsx(z,{variant:"contained",endIcon:e.jsx(te,{}),onClick:()=>{W(s)&&S(s+1)},children:"Next"})]}));return A?e.jsxs(e.Fragment,{children:[e.jsx(Fe,{activeStep:m,orientation:"vertical",sx:{marginBottom:0},children:p.map((s,l)=>e.jsxs(Oe,{children:[e.jsx(ke,{children:s}),e.jsx(Ae,{children:e.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:"20px",marginTop:"20px"},children:[l===0&&e.jsxs(e.Fragment,{children:[e.jsx(ve,{type:"text",label:"Title",error:k==="title",value:n.appTitle,fullWidth:!0,required:!0,helperText:"Container title (must be unique witin this form)",autoComplete:"off",onChange:o=>{_(ye({property:{appTitle:o.target.value}}));const D={...t};D.title=o.target.value,_(N({property:"relationshipWizard",propertyValue:D})),b(!0)}}),v(l)]}),l===1&&e.jsxs(e.Fragment,{children:[e.jsx(he,{}),e.jsx(Q,{isDetail:!0}),e.jsx(K,{app:n}),v(l)]}),l===2&&e.jsxs(e.Fragment,{children:[e.jsx(ee,{appId:r,app:n,metaData:u,relationship:t}),v(l)]}),t.cardinality===T.MANY_TO_MANY&&l===3&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{isDetail:!0,isRelationTable:!0}),e.jsx(K,{app:n,isRelationTable:!0}),v(l)]}),t.cardinality===T.MANY_TO_MANY&&l===4&&e.jsxs(e.Fragment,{children:[e.jsx(ee,{appId:r,app:n,metaData:u,relationship:t,isRelationTable:!0}),v(l)]})]})})]},s))}),m===p.length&&e.jsxs(d,{sx:{marginTop:"20px",display:"grid",gap:"20px"},children:[e.jsx(d,{children:"Relationship wizard successfully completed. Click button below to activate."}),e.jsx(z,{fullWidth:!0,variant:"contained",onClick:()=>{const s={app_id:u.app.container[0].app_id,app_title:t.title,app_dbs:t.dbs,app_tbl:t.tbl,app_cls:t.cls},l={cnt_id_master:u.app.container[0].cnt_id,cardinality:t.cardinality,join_condition:t.joins,sql:t.sql};t.cardinality===T.MANY_TO_MANY&&(l.relation_tbl=t.relationTbl,l.relation_cls=t.relationCls,l.relation_join_condition=t.relationJoins,l.relation_sql=t.relationSql),s.app_relation=JSON.stringify(l),a?(s.app_cnt=n.appCntId,ze(s,o=>{j.debug(o),(o==null?void 0:o.code)==="ok"&&(o==null?void 0:o.message)===""?(g(!1),w("Relationship updated",{variant:"success"}),C(u,()=>{w(R.contactSupport,{variant:"error"})}),b(!1)):w(R.contactSupport,{variant:"error"})},o=>{console.error(o),w(R.contactSupport,{variant:"error"})},!1)):Me(s,o=>{j.debug(o),(o==null?void 0:o.code)==="ok"&&(o==null?void 0:o.message)===""?(g(!1),w("Relationship created",{variant:"success"}),C(u,()=>{w(R.contactSupport,{variant:"error"})}),b(!1)):w(R.contactSupport,{variant:"error"})},o=>{console.error(o),w(R.contactSupport,{variant:"error"})},!1)},children:a?"Update relationship":"Create relationship"})]})]}):e.jsx(d,{children:e.jsxs(M,{fullWidth:!0,children:[e.jsxs(Ne,{fullWidth:!0,color:"primary",exclusive:!0,value:t.cardinality,onChange:(s,l)=>{if(l!==null){const o={...t};o.cardinality=l,_(N({property:"relationshipWizard",propertyValue:o}))}b(!0),O(!0)},children:[e.jsx(B,{value:T.ONE_TO_ONE,children:"1:1"}),e.jsx(B,{value:T.ONE_TO_MANY,children:"1:m"}),e.jsx(B,{value:T.MANY_TO_MANY,children:"m:m"})]}),e.jsx(F,{children:"Select cardinality."})]})})},Ke=({children:r,appId:u,embedded:a,enableWizard:i})=>{const c=J(u),f=()=>e.jsxs(d,{children:[e.jsx(d,{sx:{paddingTop:"30px"},children:r}),e.jsx(E,{title:"Close",sx:{position:"absolute",top:0,right:"8px"},children:e.jsx(Y,{onClick:()=>{i(!1),c(!1)},children:e.jsx(de,{})})})]});return a?e.jsxs(d,{sx:{marginLeft:"-10px",marginRight:"-10px",position:"relative"},children:[e.jsx(Ye,{component:"div",sx:{height:"40px",display:"flex",alignItems:"center",marginBottom:"-10px"},children:"Relationship Wizard"}),f()]}):e.jsx(d,{children:e.jsxs("fieldset",{className:"pp-fieldset",style:{position:"relative"},children:[e.jsx("legend",{children:"Relationship Wizard"}),f()]})})},Rt=({appId:r,updateSettings:u,calledFromFormSettings:a})=>{var P;j.debug(r),I(),Be(),He(r);const i=We(r);qe(),se(r);const[c,f]=x.useState(!1);j.debug("wizardOn",c);const[g,_]=x.useState(!1);j.debug("wizardIsUpdating",g);const[C,n]=x.useState("");j.debug("wizardTitle",C);const t=De(r);j.debug(t);const[b,A]=x.useState([]);j.debug(b),x.useEffect(()=>{var H,V;const L=[];if(i!==void 0&&i.length>0&&((H=t==null?void 0:t.app)==null?void 0:H.container)!==void 0&&Array.isArray((V=t==null?void 0:t.app)==null?void 0:V.container)){const re=t.app.container[0].cnt_id,oe=t.app.container[0].cnt_tbl;for(let y=0;y<i.length;y++){const q=ie(i[y].container);if(q!==null&&q.cnt_id_master===re){const le=i[y].appId;L.push({appId:le,dbAppId:i[y].container.app_id,cntId:i[y].container.cnt_id,title:i[y].container.cnt_title,dbs:i[y].container.cnt_dbs,tbl:i[y].container.cnt_tbl,cls:i[y].container.cnt_cls===void 0||i[y].container.cnt_cls===null||i[y].container.cnt_cls===""?{}:JSON.parse(i[y].container.cnt_cls),relation:q,parentTbl:oe})}}}A(L)},[r,(P=t==null?void 0:t.app)==null?void 0:P.container,i]);const[O,k]=x.useState(""),[h,p]=x.useState(-1),[m,S]=x.useState(!1),[W,v]=x.useState(""),[s,l]=x.useState(!1),[o,D]=x.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(Je,{defaultExpanded:!1,disableGutters:!0,children:[e.jsxs(Pe,{expandIcon:e.jsx(ue,{}),className:"pp-context-help-summary",children:[e.jsx("span",{children:"Relationships"}),e.jsx(Ue,{path:a===!1?"table-builder/menu/table/relationships.html":"form-builder/menu/form/relationships.html",size:22})]}),e.jsxs(Le,{children:[e.jsx(d,{sx:{marginBottom:"30px"},children:c?e.jsx(e.Fragment,{children:!g&&e.jsx(Ke,{appId:r,embedded:!1,enableWizard:f,children:e.jsx(Qe,{appId:r,embedded:!1,metaData:t,isUpdating:g,enableWizard:f,initialRelationships:b,initialTitle:""})})}):e.jsx(z,{variant:"contained",fullWidth:!0,disabled:!0,startIcon:e.jsx(me,{}),endIcon:e.jsx(te,{}),onClick:()=>{},children:"Start relationship wizard"})}),!1,e.jsx(e.Fragment,{children:!1}),e.jsxs(F,{component:"div",sx:{marginTop:"30px"},children:[e.jsxs(U,{sx:{textDecoration:"none",cursor:"pointer",display:"inline-flex","& svg":{fontSize:"1rem",marginRight:"2px"}},onClick:()=>l(!s),children:[e.jsx(G,{}),"How to use the relationship wizard?"]}),s&&e.jsxs(d,{sx:{marginTop:"20px",marginBottom:"30px",display:"grid",gap:"20px"},children:[e.jsx(d,{children:"The following relationship types are supported:"}),e.jsxs("ul",{style:{listStyle:"disc",padding:"0 40px"},children:[e.jsx("li",{children:"one to one relationship (1:1)"}),e.jsx("li",{children:"one to many relationship (1:m)"}),e.jsx("li",{children:"many to many relationship (m:m)"})]}),e.jsxs(d,{children:["To add a relationship, click the ",e.jsx("strong",{children:"start relationship wizard"})," button and follow the instructions. Relationships are added to the bottom of the form. Use the display type to define how relationships are displayed (possible values are: ",e.jsx("strong",{children:"Accordion"}),", ",e.jsx("strong",{children:"Tabs"})," or ",e.jsx("strong",{children:"Titles"}),")."]})]})]}),e.jsxs(F,{component:"div",children:[e.jsxs(U,{sx:{textDecoration:"none",cursor:"pointer",display:"inline-flex","& svg":{fontSize:"1rem",marginRight:"2px"}},onClick:()=>D(!o),children:[e.jsx(G,{}),"How to create a multi level master detail form?"]}),o&&e.jsx(d,{sx:{marginTop:"20px",display:"grid",gap:"20px"},children:e.jsxs(d,{children:["Add a ",e.jsx("strong",{children:"relationship"})," to the ",e.jsx("strong",{children:"master table"})," using the ",e.jsx("strong",{children:"relationship wizard"}),". Open the ",e.jsx("strong",{children:"detail table"}),". Open the ",e.jsx("strong",{children:"Table Builder"})," from the ",e.jsx("strong",{children:"detail table"})," or navigate to the ",e.jsx("strong",{children:"detail form"})," to open the ",e.jsx("strong",{children:"Form Builder"}),". The buttons to access the ",e.jsx("strong",{children:"Table Builders"})," and ",e.jsx("strong",{children:"Form Builders"})," are available in the footer. Open the ",e.jsx("strong",{children:"Relationships"})," section and start the ",e.jsx("strong",{children:"relationship wizard"}),"."]})})]}),e.jsx(Ee,{})]})]}),m&&e.jsx(Ie,{title:"Delete Relationship?",message:"Are you sure you want to delete this relationship? This action cannot be undone!",open:m,setOpen:S,onConfirm:()=>{}})]})};export{Rt as S,se as U};
