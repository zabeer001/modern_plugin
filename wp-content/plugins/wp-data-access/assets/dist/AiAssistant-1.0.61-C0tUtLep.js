const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./AiChat-1.0.61-BlUAFN7Q.js","./cm-1.0.61-D9ug3d5m.js","./redux-1.0.61-CrJ4jvTM.js","./vendor-1.0.61-CN03Eozo.js","./index-1.0.61-B7tjLD84.js","./Typography-1.0.61-Cg0Css-P.js","./lib-1.0.61-DoXQcMHD.js","./loglevel-1.0.61-BZ7XahX3.js","./lodash-1.0.61-C8OpKhUs.js","./moment-1.0.61-C5S46NFB.js","./ButtonBase-1.0.61-BqsrQx8o.js","./useEnhancedEffect-1.0.61-CX4-xj9Z.js","./ThemeProvider-1.0.61-4HOD8y6D.js","./Modal-1.0.61-DVFPMIPt.js","./notistack-1.0.61-0awN6uG4.js","./iconBase-1.0.61-C8saXaJ2.js","./index-1.0.61-CxkvNEVW.js","./ctc-1.0.61-D7oYqo2X.js","./hooks-1.0.61-Bklk-gZu.js","./StartQueryBuilder-1.0.61-DpIXLFtV.js","./cmJson-1.0.61-BLURwXOE.js","./rehyperaw-1.0.61-AkovKNCK.js","./markdown-1.0.61-6nAzZWly.js","./useViewHeight-1.0.61-5KT6Wm-M.js","./Spinner-1.0.61-khi9zO7Q.js","./Link-1.0.61-BHBICLVE.js","./AdminTheme-1.0.61-D8bUxwpM.js"])))=>i.map(i=>d[i]);
import{_ as X}from"./cmJson-1.0.61-BLURwXOE.js";import{j as e}from"./cm-1.0.61-D9ug3d5m.js";import{r as c}from"./redux-1.0.61-CrJ4jvTM.js";import{D as Y,P as Z}from"./ConfirmDialog-1.0.61-BrxkBu_y.js";import{R as ee,a as te}from"./RestApi-1.0.61-DdTZ_pIc.js";import{l as G,C as Q}from"./lib-1.0.61-DoXQcMHD.js";import{e as g,m as se,y as E,l as ie,ay as re,az as oe,aA as ne,aB as le,a5 as ae,F as pe,M as de}from"./index-1.0.61-B7tjLD84.js";import{A as L}from"./AdminTheme-1.0.61-D8bUxwpM.js";import{P as K}from"./index-1.0.61-D2Hg54qq.js";import{B as s}from"./Spinner-1.0.61-khi9zO7Q.js";import{I as y}from"./iconBase-1.0.61-C8saXaJ2.js";import{M as ce}from"./Modal-1.0.61-DVFPMIPt.js";import{A as F,a as _}from"./AccordionSummary-1.0.61-B21Kp3oq.js";import{A as H}from"./AccordionDetails-1.0.61-CrQNuW_u.js";import{T as $,a as O}from"./ToggleButtonGroup-1.0.61-31GAUuTm.js";import{T as U,F as me,b as xe}from"./TextField-1.0.61-DyvT2G_W.js";import{I as W}from"./InputAdornment-1.0.61-23wkGu1k.js";import{P as ue,b as he,c as ge}from"./TabPanel-1.0.61-BtYzUOMH.js";import{u as z}from"./MainQueryBuilder-1.0.61-CAqlR54P.js";import{a as V}from"./hooks-1.0.61-Bklk-gZu.js";import{n as fe,m as je}from"./StartQueryBuilder-1.0.61-DpIXLFtV.js";import{B as be}from"./cjs-1.0.61-D_0erLfe.js";import{P as Ae}from"./Menu-1.0.61-D2OtRuzX.js";import{P as we}from"./ButtonBase-1.0.61-BqsrQx8o.js";import{A as ye}from"./Autocomplete-1.0.61-CP0PiliY.js";import{e as Te}from"./notistack-1.0.61-0awN6uG4.js";import{D as ve}from"./DialogContent-1.0.61-Ws3r0VFj.js";import"./vendor-1.0.61-CN03Eozo.js";import"./rehyperaw-1.0.61-AkovKNCK.js";import"./markdown-1.0.61-6nAzZWly.js";import"./Typography-1.0.61-Cg0Css-P.js";import"./loglevel-1.0.61-BZ7XahX3.js";import"./lodash-1.0.61-C8OpKhUs.js";import"./moment-1.0.61-C5S46NFB.js";import"./ThemeProvider-1.0.61-4HOD8y6D.js";import"./useEnhancedEffect-1.0.61-CX4-xj9Z.js";import"./Collapse-1.0.61-Cww0NnSm.js";import"./Select-1.0.61-DmroHcG5.js";import"./createSvgIcon-1.0.61-DDgmYdEo.js";import"./getThemeProps-1.0.61-OfsHdeDz.js";import"./ActionsExplorer-1.0.61-Bj7vTxIj.js";import"./DatabaseTypeEnum-1.0.61-DeJfpW1u.js";import"./useViewHeight-1.0.61-5KT6Wm-M.js";import"./Close-1.0.61-CiuKDfYz.js";import"./Chip-1.0.61-C6TjQKDp.js";var A=(o=>(o.GPT35TURBO="gpt-3.5-turbo",o.GPT4TURBO="gpt-4-turbo",o))(A||{});const Ie=()=>{const o=[{title:"Be Specific About the Goal",description:"Tell the AI exactly what you want to achieve.",vague:"Vague: Write a SQL query for users.",better:"Better: Write a SQL query to select the top 10 users with the highest total order amount from the `orders` table."},{title:"Include Table and Column Names",description:"The AI needs structure. Mention the exact table and column names if known.",vague:void 0,better:"Use button ADD TABLE DEFINITIONS to add the table definitions involved in your query. The structure of selected tables will be added to your request."},{title:"Mention Output Requirements",description:"What do you want to see in the result?",vague:void 0,better:"Write a SQL query that returns user names and their total number of orders. Only include users with more than 5 orders."},{title:"Add Filters, Sorting, Limits",description:"Make it clear how the data should be narrowed or ordered.",vague:void 0,better:"Show the latest 10 orders from the `orders` table, ordered by `created_at` descending."}],[d,i]=c.useState(!1);return e.jsxs(s,{children:[e.jsx(g,{title:"AI Tips",children:e.jsx(y,{size:"small",sx:{border:"1px solid rgba(0, 0, 0, 0.23)"},onClick:()=>{i(!0)},children:e.jsx(se,{})})}),e.jsx(ce,{open:d,onClose:()=>{i(!1)},children:e.jsxs(s,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"540px",boxShadow:24,maxHeight:"80vh",overflow:"auto","& ol":{marginLeft:0,paddingInlineStart:"15px"},"& ol li":{marginBottom:"30px"},"& ol li div":{whiteSpace:"wrap"}},children:[e.jsxs(F,{disableGutters:!0,children:[e.jsx(_,{expandIcon:e.jsx(E,{}),children:"Best ChatGPT model for SQL support"}),e.jsx(H,{children:e.jsxs("ol",{children:[e.jsx("li",{children:e.jsxs(s,{sx:{lineHeight:"20px"},children:[e.jsx("strong",{children:"gpt-3.5-turbo is fine for simple tasks or if you're optimizing for speed/cost"}),", but makes more syntax/logical mistakes in SQL."]})}),e.jsxs("li",{children:[e.jsxs(s,{sx:{lineHeight:"20px"},children:[e.jsx("strong",{children:"gpt-4-turbo is more accurate with SQL logic"}),", understands complex instructions better, and returns cleaner, more consistent results. gpt-4-turbo is more expensive."]}),e.jsx(s,{sx:{marginTop:"20px",textAlign:"right"},children:e.jsxs($,{size:"small",value:A.GPT4TURBO,disabled:!0,sx:{"& button":{whiteSpace:"nowrap",textTransform:"lowercase"}},children:[e.jsx(O,{value:A.GPT35TURBO,children:"gpt-3.5-turbo"}),e.jsx(O,{value:A.GPT4TURBO,children:"gpt-4-turbo"})]})})]})]})})]}),e.jsxs(F,{disableGutters:!0,children:[e.jsx(_,{expandIcon:e.jsx(E,{}),children:"Golden Rules for Writing Good SQL Prompts"}),e.jsx(H,{children:e.jsxs("ol",{children:[...o.map(n=>e.jsx("li",{children:e.jsxs(s,{sx:{display:"flex",flexDirection:"column",gap:"10px"},children:[e.jsx(s,{children:e.jsx("strong",{children:n.title})}),e.jsx(s,{sx:{lineHeight:"20px"},children:n.description}),n.vague&&e.jsxs(s,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:"5px"},children:[e.jsx(s,{children:"❌"}),n.vague]}),e.jsxs(s,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:"5px"},children:[e.jsx(s,{sx:{alignSelf:"start",lineHeight:"20px"},children:"✅"}),e.jsx(s,{sx:{alignSelf:"start",lineHeight:"20px"},children:n.better})]})]})}))]})})]})]})})]})},Se=({prompt:o,setPrompt:d,submit:i,loading:n,tables:t,setTables:l,chatMessages:m,model:x,setModel:u,explain:f,setExplain:T})=>{var v,w,I,j,B,S,M,C,k;return e.jsxs(s,{sx:{margin:"20px",border:"1px solid rgba(0, 0, 0, 0.23)",borderRadius:"4px"},children:[e.jsx(U,{value:o,onChange:h=>{d(h.target.value)},onKeyUp:h=>{h.key==="Enter"&&!h.shiftKey&&!n&&i()},placeholder:m.length>0?"":"Write a query to select [columns] from table [table] where [user description]",fullWidth:!0,multiline:!0,minRows:2,sx:{marginBottom:0,"& fieldset":{border:"none"},"&.MuiFormControl-root textarea":{fontSize:"14px"}}}),e.jsxs(s,{sx:{display:"flex",flexDirection:"row",justifyContent:"space-between",gap:"8px",alignItems:"center",padding:"8px"},children:[e.jsxs(s,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:"8px"},children:[e.jsx(s,{children:e.jsx(Ie,{})}),t.length>0&&e.jsx(g,{title:"Table definitions added to AI request",placement:"bottom",children:e.jsx(U,{value:t.join(","),disabled:!0,slotProps:{input:{startAdornment:e.jsx(W,{position:"end",sx:{fontSize:"1rem",padding:0,margin:0},children:e.jsx(K,{})}),endAdornment:e.jsx(W,{position:"end",sx:{fontSize:"1rem",padding:0,margin:"0 4px 0 0"},children:e.jsx(g,{title:"Clear table definitions",placement:"top",children:e.jsx(y,{size:"small",onClick:h=>{l([]),h.stopPropagation()},children:e.jsx(ie,{})})})})}},sx:{"& .MuiInputBase-root":{padding:"0 0 0 8px !important"},"& input":{padding:"8px 4px !important",textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden"}}})})]}),e.jsxs(s,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:"8px"},children:[e.jsxs($,{size:"small",exclusive:!0,value:x,onChange:(h,D)=>{D!==null&&u(D)},sx:{"& button":{whiteSpace:"nowrap",textTransform:"lowercase"}},children:[e.jsx(g,{title:"Use gpt-3.5-turbo mode",children:e.jsx(O,{value:A.GPT35TURBO,children:"gpt-3.5-turbo"})}),e.jsx(g,{title:"Use gpt-4-turbo mode",children:e.jsx(O,{value:A.GPT4TURBO,children:"gpt-4-turbo"})})]}),e.jsx(g,{title:`Ask AI to add explanations (currently ${f?"enabled":"disabled"})`,children:e.jsx(y,{size:"small",sx:{border:"1px solid rgba(0, 0, 0, 0.23)"},onClick:()=>{T(!f)},children:f?e.jsx(re,{}):e.jsx(oe,{})})}),e.jsx(g,{title:"Send",children:e.jsx(y,{size:"small",onClick:i,disabled:!o.trim(),sx:{backgroundColor:(I=(w=(v=L)==null?void 0:v.palette)==null?void 0:w.primary)==null?void 0:I.dark,color:(S=(B=(j=L)==null?void 0:j.palette)==null?void 0:B.background)==null?void 0:S.default,border:"1px solid rgba(0, 0, 0, 0.23)","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.54)"},"&.Mui-disabled":{border:"1px solid rgba(0, 0, 0, 0.07)",backgroundColor:"rgba(0, 0, 0, 0.23)",color:(k=(C=(M=L)==null?void 0:M.palette)==null?void 0:C.background)==null?void 0:k.default}},children:n?e.jsx(ne,{}):e.jsx(le,{})})})]})]})]})},Ce=()=>{const o=V(),d=z();return n=>{const t=d.queries[d.tabIndex];d.aiDefinitions[t==null?void 0:t.schemaName]===void 0&&ee(Q.appUrlAiDefinitions,{dbs:n},l=>{G.debug(l),(l==null?void 0:l.code)==="ok"&&o(fe({sqlSchemaName:n,aiDefinitions:l==null?void 0:l.data}))},l=>{console.error(l)})}},De=({tables:o,setTables:d})=>{const i=z(),n=Ce(),t=i.queries[i.tabIndex],l=i.aiDefinitions[t==null?void 0:t.schemaName],m=l?Object.keys(l).map(x=>x):[];return c.useEffect(()=>{i.aiDefinitions[t==null?void 0:t.schemaName]===void 0&&n(t==null?void 0:t.schemaName)},[i.tabIndex,t==null?void 0:t.schemaName,i.aiDefinitions[t==null?void 0:t.schemaName]]),e.jsx(ue,{variant:"popover",popupId:"popup-ai-help",children:x=>e.jsxs(s,{children:[e.jsxs(be,{...he(x),variant:"outlined",color:"primary",children:[e.jsx(s,{children:"Add table definitions"}),e.jsx(ae,{})]}),e.jsx(Ae,{...ge(x),anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(we,{sx:{padding:"30px 20px 20px 20px"},children:e.jsxs(me,{fullWidth:!0,children:[e.jsx(ye,{multiple:!0,options:m,value:o,disableCloseOnSelect:!0,onChange:(u,f)=>{d(f),u.stopPropagation()},renderInput:u=>e.jsx(U,{...u,label:"Table List"}),sx:{width:"430px"}}),e.jsx(xe,{children:"The structure of the selected tables will be added your AI request."})]})})})]})})},Pe=({tables:o,setTables:d,fullScreen:i,setFullScreen:n,setOpen:t})=>e.jsxs(Y,{component:"div",sx:{margin:0,padding:"20px",display:"flex",justifyContent:"space-between",alignItems:"center","& svg":{height:"24px",width:"24px"}},children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:"5px"},children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:"5px",cursor:"move"},id:"draggable-dialog-title",children:[e.jsx(K,{}),e.jsx(s,{children:"AI Assistant"})]}),e.jsx(g,{title:"Toggle full screen",children:e.jsx(y,{onClick:()=>{n(!i)},children:e.jsx(pe,{})})})]}),e.jsxs(s,{sx:{alignSelf:"end",display:"grid",gridTemplateColumns:"auto auto",alignItems:"center",gap:"5px"},children:[e.jsx(De,{tables:o,setTables:d}),e.jsx(g,{title:"Close AI Assistant",children:e.jsx(y,{onClick:()=>{t(!1)},children:e.jsx(de,{})})})]})]}),Be=c.lazy(()=>X(()=>import("./AiChat-1.0.61-BlUAFN7Q.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]),import.meta.url)),yt=({queryKey:o,open:d,setOpen:i})=>{const n=V(),t=z(),l=[],[m,x]=c.useState(""),[u,f]=c.useState(l),[T,v]=c.useState(!1),[w,I]=c.useState([]),[j,B]=c.useState(!1),[S,M]=c.useState(A.GPT35TURBO),[C,k]=c.useState(!1);c.useEffect(()=>{var a,p;(a=t.openAI)!=null&&a.prompt&&((p=t.openAI)==null?void 0:p.queryKey)===o&&x(t.openAI.prompt)},[t.openAI]),c.useEffect(()=>{t.openAI&&t.openAI.prompt===m&&t.openAI.queryKey===o&&(D(),n(je({prompt:void 0,queryKey:""})))},[m]);const h=new AbortController,D=async()=>{if(T)h.abort();else if(m.trim()!==""){v(!0);try{const a=t.queries[t.tabIndex],p=t.aiDefinitions[a.schemaName]===void 0?[]:w.map(r=>t.aiDefinitions[a.schemaName][r]).join(`;
`)+";",R=`${m}

${p?`Table definitions:
${p}`:""}`;G.debug(R),await te(Q.appUrlAiAskSql,{prompt:R,model:S,explain:C},!1,h.signal).then(r=>{var b,P,q;G.debug(r),Array.isArray((b=r==null?void 0:r.data)==null?void 0:b.choices)?J(r.data):N((q=(P=r==null?void 0:r.data)==null?void 0:P.error)==null?void 0:q.message)}).catch(r=>{var b,P;console.error(r),N((P=(b=r==null?void 0:r.response)==null?void 0:b.data)==null?void 0:P.message)})}catch(a){console.error(a),Te("Something went wrong. Please try again.",{variant:"error"})}finally{v(!1)}}},N=a=>{const p=[...u];p.push({message:m,type:"me"}),p.push({message:a,type:"ai",isError:!0}),f(p),x("")},J=a=>{const p=[...u];p.push({message:m,type:"me"}),a.choices.map(R=>{var r,b;p.push({message:((b=(r=R.message)==null?void 0:r.content)==null?void 0:b.trim())||"No response from ChatGPT.",type:"ai"})}),a!=null&&a.msg&&p.push({message:a.msg,type:"ai",isNote:!0}),f(p),x("")};return e.jsxs(ve,{open:d,onClose:()=>i(!1),PaperComponent:Z,sx:{"& .MuiPaper-root":{display:"grid",gridTemplateRows:"auto 1fr auto",width:j?"100vw":"600px",height:j?"calc(var(--ppViewHeight, 1vh) * 100)":"600px",...j&&{maxWidth:"unset"}}},"aria-labelledby":"open-query-dialog",closeAfterTransition:!1,children:[e.jsx(Pe,{tables:w,setTables:I,fullScreen:j,setFullScreen:B,setOpen:i}),e.jsx(c.Suspense,{children:e.jsx(Be,{chatMessages:u,loading:T,fullScreen:j})}),e.jsx(Se,{prompt:m,setPrompt:x,submit:D,loading:T,tables:w,setTables:I,chatMessages:u,model:S,setModel:M,explain:C,setExplain:k})]})};export{yt as default};
